#!/bin/bash

function install_rar() {
    if [[ -z $(which rar) ]]; then
        apt_install rar unrar
    fi
}

function _rar() {
    cd /tmp
    wget -q http://www.rarlab.com/rar/rarlinux-x64-5.5.0.tar.gz
    tar -xzf rarlinux-x64-5.5.0.tar.gz > /dev/null 2>&1
    cp rar/*rar /bin > /dev/null 2>&1
    rm -rf rarlinux*.tar.gz > /dev/null 2>&1
    rm -rf /tmp/rar > /dev/null 2>&1
}

# Removes a file or a directory in case it exists
function rm_if_exists() {
    path="$1"
    if [[ -e "$path" ]]; then
        rm -rf "$path"
    fi
}

function port() {
    LOW_BOUND=$1
    UPPER_BOUND=$2
    comm -23 <(seq ${LOW_BOUND} ${UPPER_BOUND} | sort) <(ss -Htan | awk '{print $4}' | cut -d':' -f2 | sort -u) | shuf | head -n 1
}

function check_ram() {
    if [[ -z $1 ]]; then
        echo_error "Must specify a value to compare"
        return 1
    fi
    if ! dpkg -s bc > /dev/null 2>&1; then
        apt_install bc
    fi
    ramtotal=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    swaptotal=$(grep SwapTotal /proc/meminfo | awk '{print $2}')
    total=$(echo "$swaptotal + $ramtotal" | bc -l | numfmt --from-unit=1024)
    needs=$(echo $1 | numfmt --from=iec)
    if [[ $needs -gt $total ]]; then
        false
    else
        true
    fi
}

function tmp_swap_on() {
    echo_progress_start "Setup is enabling the use of a temporary 2GB swap file"
    dd if=/dev/zero of=/.swapfile bs=1M count=2048 > /dev/null 2>&1 || {
        echo_error "Cannot continue with install because swap file could not be created. Does device have 2GB of free space?"
        exit 1
    }
    mkswap /.swapfile > /dev/null 2>&1
    swapon /.swapfile > /dev/null 2>&1
    echo_progress_done 'Swap enabled'
}

function tmp_swap_off() {
    swapoff /.swapfile > /dev/null 2>&1
    rm -f /.swapfile > /dev/null 2>&1
}
